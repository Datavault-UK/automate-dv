@fixture.set_workdir
Feature: Multi Active Satellites - Loading in cycles using separate manual loads of MAS behaviour with one CDK (sqlserver)
  This file includes tests for debugging purposes
  It tests a series of loading cycles over an increasing number of days, i.e. one to four days

  @fixture.multi_active_satellite_cycle_sqlserver
  Scenario: [SAT-CYCLE] 1-day cycle
    Given the RAW_STAGE stage is empty
    And the MULTI_ACTIVE_SATELLITE ma_sat is empty

    # ================ DAY 1 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1001        | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # =============== CHECKS ===================
    Then the MULTI_ACTIVE_SATELLITE table should contain expected data
      | CUSTOMER_PK | HASHDIFF                                  | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1211')  | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1221')  | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1231')  | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1212')    | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1213') | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1233') | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1214')   | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1224')   | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1234')   | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1215')  | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1225')  | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1235')  | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |


  @fixture.multi_active_satellite_cycle_sqlserver
  Scenario: [SAT-CYCLE] 2-day cycle
    Given the RAW_STAGE stage is empty
    And the MULTI_ACTIVE_SATELLITE ma_sat is empty

    # ================ DAY 1 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1001        | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 2 ===================
    # Beah (hd-), Chris (hd-), David (new), Jenny (+)
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beah          | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | 1002        | Beah          | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | 1003        | Chris         | 17-214-233-1223 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1236 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1232 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1242 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-02     | 2019-01-02 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # =============== CHECKS ===================
    Then the MULTI_ACTIVE_SATELLITE table should contain expected data
      | CUSTOMER_PK | HASHDIFF                                  | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1211')  | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1221')  | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1231')  | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1212')    | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1213') | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1233') | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1214')   | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1224')   | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1234')   | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1215')  | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1225')  | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1235')  | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1212')    | Beah          | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1222')    | Beah          | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1003') | md5('1003\|\|CHRIS\|\|17-214-233-1223')   | Chris         | 17-214-233-1223 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1216')   | David         | 17-214-233-1216 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1226')   | David         | 17-214-233-1226 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1236')   | David         | 17-214-233-1236 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1212')   | Jenny         | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1222')   | Jenny         | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1232')   | Jenny         | 17-214-233-1232 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1242')   | Jenny         | 17-214-233-1242 | 2019-01-02     | 2019-01-02 | *      |


  @fixture.multi_active_satellite_cycle_sqlserver
  Scenario: [SAT-CYCLE] 3-day cycle
    Given the RAW_STAGE stage is empty
    And the MULTI_ACTIVE_SATELLITE ma_sat is empty

    # ================ DAY 1 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1001        | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 2 ===================
    # Beah (hd-), Chris (hd-), David (new), Jenny (+)
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beah          | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | 1002        | Beah          | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | 1003        | Chris         | 17-214-233-1223 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1236 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1232 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1242 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-02     | 2019-01-02 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 3 ===================
    # Beth (hd+), David (-), Freia (new, dupl)
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beth          | 17-214-233-1312 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-03     | 2019-01-03 | *      |
      | 1003        | Chris         | 17-214-233-1223 | 2019-01-03     | 2019-01-03 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-03     | 2019-01-03 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-03     | 2019-01-03 | *      |
      | 1006        | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |
      | 1006        | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # =============== CHECKS ===================
    Then the MULTI_ACTIVE_SATELLITE table should contain expected data
      | CUSTOMER_PK | HASHDIFF                                  | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1211')  | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1221')  | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1231')  | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1212')    | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1213') | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1233') | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1214')   | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1224')   | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1234')   | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1215')  | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1225')  | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1235')  | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1212')    | Beah          | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1222')    | Beah          | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1003') | md5('1003\|\|CHRIS\|\|17-214-233-1223')   | Chris         | 17-214-233-1223 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1216')   | David         | 17-214-233-1216 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1226')   | David         | 17-214-233-1226 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1236')   | David         | 17-214-233-1236 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1212')   | Jenny         | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1222')   | Jenny         | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1232')   | Jenny         | 17-214-233-1232 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1242')   | Jenny         | 17-214-233-1242 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1312')    | Beth          | 17-214-233-1312 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1216')   | David         | 17-214-233-1216 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1226')   | David         | 17-214-233-1226 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1006') | md5('1006\|\|FREIA\|\|17-214-233-1212')   | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |


  @fixture.multi_active_satellite_cycle_sqlserver
  Scenario: [SAT-CYCLE] 4-day cycle
    Given the RAW_STAGE stage is empty
    And the MULTI_ACTIVE_SATELLITE ma_sat is empty

    # ================ DAY 1 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1001        | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 2 ===================
    # Beah (hd-), Chris (hd-), David (new), Jenny (+)
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beah          | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | 1002        | Beah          | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | 1003        | Chris         | 17-214-233-1223 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1236 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1232 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1242 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-02     | 2019-01-02 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 3 ===================
    # Beth (hd+), David (-), Freia (new, dupl)
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beth          | 17-214-233-1312 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-03     | 2019-01-03 | *      |
      | 1003        | Chris         | 17-214-233-1223 | 2019-01-03     | 2019-01-03 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-03     | 2019-01-03 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-03     | 2019-01-03 | *      |
      | 1006        | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |
      | 1006        | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 4 ===================
    # Beah (hd), Charley (hd), Geoff (new, dupl), Jenny (hd),
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beah          | 17-214-233-1212 | 2019-01-04     | 2019-01-04 | *      |
      | 1002        | Beah          | 17-214-233-1222 | 2019-01-04     | 2019-01-04 | *      |
      | 1002        | Beah          | 17-214-233-1232 | 2019-01-04     | 2019-01-04 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-04     | 2019-01-04 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-04     | 2019-01-04 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-04     | 2019-01-04 | *      |
      | 1007        | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | 1007        | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | 1007        | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1312 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1322 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1332 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1342 | 2019-01-04     | 2019-01-04 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # =============== CHECKS ===================
    Then the MULTI_ACTIVE_SATELLITE table should contain expected data
      | CUSTOMER_PK | HASHDIFF                                  | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1211')  | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1221')  | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1231')  | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1212')    | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1213') | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1233') | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1214')   | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1224')   | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1234')   | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1215')  | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1225')  | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1235')  | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1212')    | Beah          | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1222')    | Beah          | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1003') | md5('1003\|\|CHRIS\|\|17-214-233-1223')   | Chris         | 17-214-233-1223 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1216')   | David         | 17-214-233-1216 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1226')   | David         | 17-214-233-1226 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1236')   | David         | 17-214-233-1236 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1212')   | Jenny         | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1222')   | Jenny         | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1232')   | Jenny         | 17-214-233-1232 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1242')   | Jenny         | 17-214-233-1242 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1312')    | Beth          | 17-214-233-1312 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1216')   | David         | 17-214-233-1216 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1226')   | David         | 17-214-233-1226 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1006') | md5('1006\|\|FREIA\|\|17-214-233-1212')   | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1212')    | Beah          | 17-214-233-1212 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1222')    | Beah          | 17-214-233-1222 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1232')    | Beah          | 17-214-233-1232 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1007') | md5('1007\|\|GEOFF\|\|17-214-233-1219')   | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1312')   | Jenny         | 17-214-233-1312 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1322')   | Jenny         | 17-214-233-1322 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1332')   | Jenny         | 17-214-233-1332 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1342')   | Jenny         | 17-214-233-1342 | 2019-01-04     | 2019-01-04 | *      |
