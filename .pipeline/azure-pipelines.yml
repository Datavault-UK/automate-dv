trigger:
  batch: true
  branches:
    include:
      - develop
      - stage/*
    exclude:
      - feat/*

pool:
  vmImage: ubuntu-latest

variables:
  PIPELINE_BRANCH: $(Build.SourceBranchName)

resources:
  containers:
    - container: mssql
      image: mcr.microsoft.com/mssql/server:2019-latest
      ports:
        - 1433:1433
      options: --user 0
      env:
        ACCEPT_EULA: Y
        MSSQL_SA_PASSWORD: SlA7Qs3w!O
        MSSQL_PID: Developer

stages:
  - stage: 'integration_tests_sqlserver'
    displayName: 'Run Integration Tests (MS SQL Server)'
    jobs:
      - job: 'staging'
        displayName: 'Staging'
        services:
          mssql: mssql
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.9'
          - template: templates/install-dependencies-steps.yml
          - script: sqlcmd -S localhost -U sa -P SlA7Qs3w!O -d master -i docker_scripts/sqlserver/setup.sql
            displayName: "Setup SQLServer"
          - script: inv setup -p sqlserver -e pipeline
            displayName: "Setup harness"
          - script: inv run-integration-tests -s staging -p sqlserver
            displayName: "Run feature files"
            env:
              PIPELINE_JOB: $(Agent.JobName)
