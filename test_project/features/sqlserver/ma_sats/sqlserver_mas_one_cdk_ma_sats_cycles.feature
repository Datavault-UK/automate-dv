@fixture.set_workdir
Feature: Multi Active Satellites - Loading in cycles using separate manual loads of MAS behaviour with one CDK (sqlserver)

  @fixture.multi_active_satellite_cycle_sqlserver
  Scenario: [SAT-CYCLE] MULTI_ACTIVE_SATELLITE load over several cycles with sets of records keeping the group size the same while having one or more records changed
    Given the RAW_STAGE stage is empty
    And the MULTI_ACTIVE_SATELLITE ma_sat is empty

    # ================ DAY 1 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1001        | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 2 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1001        | Albert        | 17-214-233-1211 | 2019-01-02     | 2019-01-02 | *      |
      | 1001        | Albert        | 17-214-233-1221 | 2019-01-02     | 2019-01-02 | *      |
      | 1001        | Albert        | 17-214-233-1331 | 2019-01-02     | 2019-01-02 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 3 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beth          | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1322 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1332 | 2019-01-03     | 2019-01-03 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 4 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1003        | Charley       | 17-214-233-1313 | 2019-01-04     | 2019-01-04 | *      |
      | 1003        | Charley       | 17-214-233-1323 | 2019-01-04     | 2019-01-04 | *      |
      | 1003        | Charlie       | 17-214-233-1333 | 2019-01-04     | 2019-01-04 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # =============== CHECKS ===================
    Then the MULTI_ACTIVE_SATELLITE table should contain expected data
      | CUSTOMER_PK | HASHDIFF                                  | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1211')  | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1221')  | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1231')  | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1212')    | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1213') | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1233') | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1211')  | Albert        | 17-214-233-1211 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1221')  | Albert        | 17-214-233-1221 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1331')  | Albert        | 17-214-233-1331 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1212')    | Beth          | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1322')    | Beth          | 17-214-233-1322 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1332')    | Beth          | 17-214-233-1332 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1313') | Charley       | 17-214-233-1313 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1323') | Charley       | 17-214-233-1323 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1003') | md5('1003\|\|CHARLIE\|\|17-214-233-1333') | Charlie       | 17-214-233-1333 | 2019-01-04     | 2019-01-04 | *      |

  @fixture.multi_active_satellite_cycle_sqlserver
  Scenario: [SAT-CYCLE-NULLS] MULTI_ACTIVE_SATELLITE load over several cycles with NULL records
    Given the RAW_STAGE stage is empty
    And the MULTI_ACTIVE_SATELLITE ma_sat is empty

    # ================ DAY 1 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1001        | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 2 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | <null>      | <null>        | <null>          | 2019-01-02     | 2019-01-02 | *      |
      | <null>      | <null>        | 17-214-233-1311 | 2019-01-02     | 2019-01-02 | *      |
      | <null>      | Albert        | 17-214-233-1321 | 2019-01-02     | 2019-01-02 | *      |
      | 1001        | <null>        | 17-214-233-1311 | 2019-01-02     | 2019-01-02 | *      |
      | 1001        | Albert        | 17-214-233-1331 | 2019-01-02     | 2019-01-02 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 3 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | <null>      | <null>        | <null>          | 2019-01-03     | 2019-01-03 | *      |
      | <null>      | Beth          | <null>          | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | <null>          | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | <null>        | 17-214-233-1322 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1332 | 2019-01-03     | 2019-01-03 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 4 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | <null>      | <null>        | <null>          | 2019-01-04     | 2019-01-04 | *      |
      | <null>      | Charley       | <null>          | 2019-01-04     | 2019-01-04 | *      |
      | <null>      | <null>        | 17-214-233-1313 | 2019-01-04     | 2019-01-04 | *      |
      | 1003        | <null>        | <null>          | 2019-01-04     | 2019-01-04 | *      |
      | 1003        | <null>        | 17-214-233-1313 | 2019-01-04     | 2019-01-04 | *      |
      | 1003        | <null>        | 17-214-233-1323 | 2019-01-04     | 2019-01-04 | *      |
      | 1003        | <null>        | 17-214-233-1333 | 2019-01-04     | 2019-01-04 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # =============== CHECKS ===================
    Then the MULTI_ACTIVE_SATELLITE table should contain expected data
      | CUSTOMER_PK | HASHDIFF                                  | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1211')  | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1221')  | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1231')  | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1212')    | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1213') | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1233') | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|^^\|\|17-214-233-1311')      | <null>        | 17-214-233-1311 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1331')  | Albert        | 17-214-233-1331 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1002') | md5('1002\|\|^^\|\|17-214-233-1322')      | <null>        | 17-214-233-1322 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1332')    | Beth          | 17-214-233-1332 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1003') | md5('1003\|\|^^\|\|17-214-233-1313')      | <null>        | 17-214-233-1313 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1003') | md5('1003\|\|^^\|\|17-214-233-1323')      | <null>        | 17-214-233-1323 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1003') | md5('1003\|\|^^\|\|17-214-233-1333')      | <null>        | 17-214-233-1333 | 2019-01-04     | 2019-01-04 | *      |

  @fixture.multi_active_satellite_cycle_sqlserver
  Scenario: [SAT-CYCLE] MULTI_ACTIVE_SATELLITE load over several cycles with a mix of record change cases
    Given the RAW_STAGE stage is empty
    And the MULTI_ACTIVE_SATELLITE ma_sat is empty

    # ================ DAY 1 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1001        | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 2 ===================
    # Beah (hd-), Chris (hd-), David (new), Jenny (+)
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beah          | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | 1002        | Beah          | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | 1003        | Chris         | 17-214-233-1223 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1236 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1232 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1242 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-02     | 2019-01-02 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 3 ===================
    # Beth (hd+), David (-), Freia (new, dupl)
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beth          | 17-214-233-1312 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-03     | 2019-01-03 | *      |
      | 1003        | Chris         | 17-214-233-1223 | 2019-01-03     | 2019-01-03 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-03     | 2019-01-03 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-03     | 2019-01-03 | *      |
      | 1006        | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |
      | 1006        | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 4 ===================
    # Beah (hd), Charley (hd), Geoff (new, dupl), Jenny (hd),
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beah          | 17-214-233-1212 | 2019-01-04     | 2019-01-04 | *      |
      | 1002        | Beah          | 17-214-233-1222 | 2019-01-04     | 2019-01-04 | *      |
      | 1002        | Beah          | 17-214-233-1232 | 2019-01-04     | 2019-01-04 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-04     | 2019-01-04 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-04     | 2019-01-04 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-04     | 2019-01-04 | *      |
      | 1007        | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | 1007        | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | 1007        | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1312 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1322 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1332 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1342 | 2019-01-04     | 2019-01-04 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # =============== CHECKS ===================
    Then the MULTI_ACTIVE_SATELLITE table should contain expected data
      | CUSTOMER_PK | HASHDIFF                                  | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1211')  | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1221')  | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1001') | md5('1001\|\|ALBERT\|\|17-214-233-1231')  | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1212')    | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1213') | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1233') | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1214')   | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1224')   | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1234')   | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1215')  | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1225')  | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1012') | md5('1012\|\|ALBERT\|\|17-214-233-1235')  | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1212')    | Beah          | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1222')    | Beah          | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1003') | md5('1003\|\|CHRIS\|\|17-214-233-1223')   | Chris         | 17-214-233-1223 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1216')   | David         | 17-214-233-1216 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1226')   | David         | 17-214-233-1226 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1236')   | David         | 17-214-233-1236 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1212')   | Jenny         | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1222')   | Jenny         | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1232')   | Jenny         | 17-214-233-1232 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1242')   | Jenny         | 17-214-233-1242 | 2019-01-02     | 2019-01-02 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1312')    | Beth          | 17-214-233-1312 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1216')   | David         | 17-214-233-1216 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1004') | md5('1004\|\|DAVID\|\|17-214-233-1226')   | David         | 17-214-233-1226 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1006') | md5('1006\|\|FREIA\|\|17-214-233-1212')   | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1212')    | Beah          | 17-214-233-1212 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1222')    | Beah          | 17-214-233-1222 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1002') | md5('1002\|\|BEAH\|\|17-214-233-1232')    | Beah          | 17-214-233-1232 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1003') | md5('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1007') | md5('1007\|\|GEOFF\|\|17-214-233-1219')   | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1312')   | Jenny         | 17-214-233-1312 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1322')   | Jenny         | 17-214-233-1322 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1332')   | Jenny         | 17-214-233-1332 | 2019-01-04     | 2019-01-04 | *      |
      | md5('1010') | md5('1010\|\|JENNY\|\|17-214-233-1342')   | Jenny         | 17-214-233-1342 | 2019-01-04     | 2019-01-04 | *      |

  @fixture.multi_active_satellite_cycle_sqlserver
  @fixture.sha
  Scenario: [SAT-CYCLE-SHA] MULTI_ACTIVE_SATELLITE load over several cycles
    Given the RAW_STAGE stage is empty
    And the MULTI_ACTIVE_SATELLITE ma_sat is empty

    # ================ DAY 1 ===================
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1001        | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | 1001        | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | 1003        | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | 1010        | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 2 ===================
    # Beah (hd-), Chris (hd-), David (new), Jenny (+)
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beah          | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | 1002        | Beah          | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | 1003        | Chris         | 17-214-233-1223 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-02     | 2019-01-02 | *      |
      | 1004        | David         | 17-214-233-1236 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1232 | 2019-01-02     | 2019-01-02 | *      |
      | 1010        | Jenny         | 17-214-233-1242 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1215 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1225 | 2019-01-02     | 2019-01-02 | *      |
      | 1012        | Albert        | 17-214-233-1235 | 2019-01-02     | 2019-01-02 | *      |
    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 3 ===================
    # Beth (hd+), David (-), Freia (new, dupl)
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beth          | 17-214-233-1312 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1222 | 2019-01-03     | 2019-01-03 | *      |
      | 1002        | Beth          | 17-214-233-1232 | 2019-01-03     | 2019-01-03 | *      |
      | 1003        | Chris         | 17-214-233-1223 | 2019-01-03     | 2019-01-03 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-03     | 2019-01-03 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-03     | 2019-01-03 | *      |
      | 1006        | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |
      | 1006        | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # ================ DAY 4 ===================
    # Beah (hd), Charley (hd), Geoff (new, dupl), Jenny (hd),
    When the RAW_STAGE is loaded
      | CUSTOMER_ID | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | 1002        | Beah          | 17-214-233-1212 | 2019-01-04     | 2019-01-04 | *      |
      | 1002        | Beah          | 17-214-233-1222 | 2019-01-04     | 2019-01-04 | *      |
      | 1002        | Beah          | 17-214-233-1232 | 2019-01-04     | 2019-01-04 | *      |
      | 1003        | Charley       | 17-214-233-1223 | 2019-01-04     | 2019-01-04 | *      |
      | 1004        | David         | 17-214-233-1216 | 2019-01-04     | 2019-01-04 | *      |
      | 1004        | David         | 17-214-233-1226 | 2019-01-04     | 2019-01-04 | *      |
      | 1007        | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | 1007        | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | 1007        | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1312 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1322 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1332 | 2019-01-04     | 2019-01-04 | *      |
      | 1010        | Jenny         | 17-214-233-1342 | 2019-01-04     | 2019-01-04 | *      |

    And I create the STG_CUSTOMER stage
    And I load the MULTI_ACTIVE_SATELLITE ma_sat

    # =============== CHECKS ===================
    Then the MULTI_ACTIVE_SATELLITE table should contain expected data
      | CUSTOMER_PK | HASHDIFF                                  | CUSTOMER_NAME | CUSTOMER_PHONE  | EFFECTIVE_FROM | LOAD_DATE  | SOURCE |
      | sha('1001') | sha('1001\|\|ALBERT\|\|17-214-233-1211')  | Albert        | 17-214-233-1211 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1001') | sha('1001\|\|ALBERT\|\|17-214-233-1221')  | Albert        | 17-214-233-1221 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1001') | sha('1001\|\|ALBERT\|\|17-214-233-1231')  | Albert        | 17-214-233-1231 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1002') | sha('1002\|\|BETH\|\|17-214-233-1212')    | Beth          | 17-214-233-1212 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1002') | sha('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1002') | sha('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1003') | sha('1003\|\|CHARLEY\|\|17-214-233-1213') | Charley       | 17-214-233-1213 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1003') | sha('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1003') | sha('1003\|\|CHARLEY\|\|17-214-233-1233') | Charley       | 17-214-233-1233 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1214')   | Jenny         | 17-214-233-1214 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1224')   | Jenny         | 17-214-233-1224 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1234')   | Jenny         | 17-214-233-1234 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1012') | sha('1012\|\|ALBERT\|\|17-214-233-1215')  | Albert        | 17-214-233-1215 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1012') | sha('1012\|\|ALBERT\|\|17-214-233-1225')  | Albert        | 17-214-233-1225 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1012') | sha('1012\|\|ALBERT\|\|17-214-233-1235')  | Albert        | 17-214-233-1235 | 2019-01-01     | 2019-01-01 | *      |
      | sha('1002') | sha('1002\|\|BEAH\|\|17-214-233-1212')    | Beah          | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | sha('1002') | sha('1002\|\|BEAH\|\|17-214-233-1222')    | Beah          | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | sha('1003') | sha('1003\|\|CHRIS\|\|17-214-233-1223')   | Chris         | 17-214-233-1223 | 2019-01-02     | 2019-01-02 | *      |
      | sha('1004') | sha('1004\|\|DAVID\|\|17-214-233-1216')   | David         | 17-214-233-1216 | 2019-01-02     | 2019-01-02 | *      |
      | sha('1004') | sha('1004\|\|DAVID\|\|17-214-233-1226')   | David         | 17-214-233-1226 | 2019-01-02     | 2019-01-02 | *      |
      | sha('1004') | sha('1004\|\|DAVID\|\|17-214-233-1236')   | David         | 17-214-233-1236 | 2019-01-02     | 2019-01-02 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1212')   | Jenny         | 17-214-233-1212 | 2019-01-02     | 2019-01-02 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1222')   | Jenny         | 17-214-233-1222 | 2019-01-02     | 2019-01-02 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1232')   | Jenny         | 17-214-233-1232 | 2019-01-02     | 2019-01-02 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1242')   | Jenny         | 17-214-233-1242 | 2019-01-02     | 2019-01-02 | *      |
      | sha('1002') | sha('1002\|\|BETH\|\|17-214-233-1312')    | Beth          | 17-214-233-1312 | 2019-01-03     | 2019-01-03 | *      |
      | sha('1002') | sha('1002\|\|BETH\|\|17-214-233-1222')    | Beth          | 17-214-233-1222 | 2019-01-03     | 2019-01-03 | *      |
      | sha('1002') | sha('1002\|\|BETH\|\|17-214-233-1232')    | Beth          | 17-214-233-1232 | 2019-01-03     | 2019-01-03 | *      |
      | sha('1004') | sha('1004\|\|DAVID\|\|17-214-233-1216')   | David         | 17-214-233-1216 | 2019-01-03     | 2019-01-03 | *      |
      | sha('1004') | sha('1004\|\|DAVID\|\|17-214-233-1226')   | David         | 17-214-233-1226 | 2019-01-03     | 2019-01-03 | *      |
      | sha('1006') | sha('1006\|\|FREIA\|\|17-214-233-1212')   | Freia         | 17-214-233-1212 | 2019-01-03     | 2019-01-03 | *      |
      | sha('1002') | sha('1002\|\|BEAH\|\|17-214-233-1212')    | Beah          | 17-214-233-1212 | 2019-01-04     | 2019-01-04 | *      |
      | sha('1002') | sha('1002\|\|BEAH\|\|17-214-233-1222')    | Beah          | 17-214-233-1222 | 2019-01-04     | 2019-01-04 | *      |
      | sha('1002') | sha('1002\|\|BEAH\|\|17-214-233-1232')    | Beah          | 17-214-233-1232 | 2019-01-04     | 2019-01-04 | *      |
      | sha('1003') | sha('1003\|\|CHARLEY\|\|17-214-233-1223') | Charley       | 17-214-233-1223 | 2019-01-04     | 2019-01-04 | *      |
      | sha('1007') | sha('1007\|\|GEOFF\|\|17-214-233-1219')   | Geoff         | 17-214-233-1219 | 2019-01-04     | 2019-01-04 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1312')   | Jenny         | 17-214-233-1312 | 2019-01-04     | 2019-01-04 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1322')   | Jenny         | 17-214-233-1322 | 2019-01-04     | 2019-01-04 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1332')   | Jenny         | 17-214-233-1332 | 2019-01-04     | 2019-01-04 | *      |
      | sha('1010') | sha('1010\|\|JENNY\|\|17-214-233-1342')   | Jenny         | 17-214-233-1342 | 2019-01-04     | 2019-01-04 | *      |
